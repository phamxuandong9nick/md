<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Markdown Editor Of Nick</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Marked.js 12.0.2 -->
    <script src="https://cdn.jsdelivr.net/npm/marked@12.0.2/marked.min.js"></script>
    <!-- DOMPurify -->
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
    <!-- Html2Pdf.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style id="content-styles">
        /* --- Styles --- */
        .markdown-body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
            font-size: 16px; line-height: 1.6; word-wrap: break-word; color: #24292f; background-color: #fff; padding: 20px;
        }
        .markdown-body h1, .markdown-body h2, .markdown-body h3 { margin-top: 24px; margin-bottom: 16px; font-weight: 600; line-height: 1.25; scroll-margin-top: 80px; }
        .markdown-body h1 { font-size: 2em; border-bottom: 1px solid #d0d7de; padding-bottom: 0.3em; }
        .markdown-body h2 { font-size: 1.5em; border-bottom: 1px solid #d0d7de; padding-bottom: 0.3em; }
        .markdown-body a { color: #0969da; text-decoration: none; }
        .markdown-body a:hover { text-decoration: underline; }
        .markdown-body ul, .markdown-body ol { padding-left: 2em; margin-bottom: 16px; }
        .markdown-body ul { list-style-type: disc; }
        .markdown-body ol { list-style-type: decimal; }
        .markdown-body blockquote { padding: 0 1em; color: #57606a; border-left: 0.25em solid #d0d7de; margin-bottom: 16px; }
        
        .markdown-body code { padding: 0.2em 0.4em; margin: 0; font-size: 85%; background-color: rgba(175, 184, 193, 0.2); border-radius: 6px; font-family: ui-monospace, SFMono-Regular, SF Mono, Menlo, Consolas, Liberation Mono, monospace; }
        .code-container { position: relative; margin-bottom: 16px; background-color: #f6f8fa; border-radius: 6px; border: 1px solid #d0d7de; page-break-inside: avoid; }
        .code-container pre { padding: 16px; overflow: auto; margin: 0; border-radius: 6px; padding-top: 40px; }
        .code-container pre code { background-color: transparent; padding: 0; white-space: pre; }

        .copy-btn { position: absolute; top: 5px; right: 5px; padding: 4px 10px; font-size: 12px; color: #24292f; background-color: #f3f4f6; border: 1px solid #d0d7de; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 6px; font-weight: 600; user-select: none; z-index: 10; box-shadow: 0 1px 2px rgba(0,0,0,0.05); line-height: 1; }
        .copy-btn:hover { background-color: #fff; color: #0969da; border-color: #0969da; }

        .markdown-body img { max-width: 100%; box-sizing: border-box; background-color: #fff; border: 1px solid #d0d7de; border-radius: 6px; page-break-inside: avoid; }
        .markdown-body table { border-spacing: 0; border-collapse: collapse; margin-bottom: 16px; width: 100%; }
        .markdown-body table th, .markdown-body table td { padding: 6px 13px; border: 1px solid #d0d7de; }
        .markdown-body table tr:nth-child(2n) { background-color: #f6f8fa; }

        #back-to-top { position: fixed; bottom: 30px; right: 30px; background-color: #2563eb; color: white; width: 50px; height: 50px; border-radius: 50%; display: none; justify-content: center; align-items: center; cursor: pointer; border: none; box-shadow: 0 4px 6px rgba(0,0,0,0.2); z-index: 9999; }
    </style>
</head>
<body class="bg-gray-100 h-screen flex flex-col overflow-hidden">

    <!-- Header -->
    <header class="bg-gray-900 text-white h-16 flex justify-between items-center px-4 shadow-md shrink-0 z-10 gap-2">
        <div class="flex items-center gap-2 min-w-fit">
            <span class="font-bold text-lg tracking-wide hidden md:inline">MD Pro V7</span>
        </div>
        
        <div class="flex gap-2 items-center overflow-x-auto">
            <button onclick="resetStorage()" class="text-xs text-gray-400 hover:text-white underline px-1 whitespace-nowrap">Reset</button>

            <!-- N√∫t Copy MD -->
            <button onclick="copyMarkdownRaw()" title="Copy n·ªôi dung Markdown" class="p-2 bg-gray-700 hover:bg-gray-600 rounded border border-gray-600">
                <span class="text-xs font-bold">MD</span>
            </button>

            <!-- N·∫°p ·∫£nh -->
            <input type="file" id="imageInput" multiple accept="image/*" class="hidden">
            <button onclick="document.getElementById('imageInput').click()" title="N·∫°p ·∫£nh local" class="flex items-center gap-1 bg-gray-700 hover:bg-gray-600 text-gray-200 px-3 py-1.5 rounded text-sm font-medium border border-gray-600 whitespace-nowrap">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
                <span id="img-btn-text">·∫¢nh</span>
            </button>

            <!-- Divider -->
            <div class="w-px h-6 bg-gray-600 mx-1"></div>

            <!-- Copy HTML Clipboard -->
            <button onclick="copyHtmlToClipboard()" title="Copy HTML v√†o Clipboard" class="flex items-center gap-1 bg-blue-600 hover:bg-blue-500 text-white px-3 py-1.5 rounded text-sm font-medium whitespace-nowrap">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
                <span>Copy HTML</span>
            </button>

            <!-- Download HTML -->
            <button onclick="downloadHtmlFile()" title="T·∫£i file .html" class="flex items-center gap-1 bg-green-600 hover:bg-green-500 text-white px-3 py-1.5 rounded text-sm font-medium whitespace-nowrap">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                <span>.html</span>
            </button>

            <!-- Download PDF -->
            <button onclick="downloadPdfFile()" title="T·∫£i file .pdf" class="flex items-center gap-1 bg-red-600 hover:bg-red-500 text-white px-3 py-1.5 rounded text-sm font-medium whitespace-nowrap">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14 2z"/><polyline points="14 2 14 8 20 8"/><path d="M12 18v-6"/><path d="M9 15l3 3 3-3"/></svg>
                <span>.pdf</span>
            </button>
        </div>
    </header>

    <main class="flex-1 flex flex-row overflow-hidden">
        <div class="w-1/2 flex flex-col border-r border-gray-300">
            <div class="bg-gray-100 px-4 py-2 text-xs font-bold uppercase border-b border-gray-300 flex justify-between">
                <span>Markdown Input</span>
                <span id="save-status" class="text-green-600 font-normal hidden">ƒê√£ l∆∞u</span>
            </div>
            <textarea id="editor" class="flex-1 w-full p-6 resize-none outline-none font-mono text-gray-800 text-sm leading-relaxed bg-gray-50 focus:bg-white transition-colors" spellcheck="false"></textarea>
        </div>
        <div class="w-1/2 flex flex-col bg-white">
            <div class="bg-gray-100 px-4 py-2 text-xs font-bold uppercase border-b border-gray-300">Preview</div>
            <div id="preview" class="flex-1 w-full p-0 overflow-y-auto"><div class="markdown-body h-full"></div></div>
        </div>
    </main>

    <div id="toast" class="fixed bottom-5 right-5 bg-gray-800 text-white px-4 py-3 rounded shadow-lg transform translate-y-32 transition-transform duration-300 flex items-center gap-2 z-50">
        <span id="toast-icon">‚úÖ</span>
        <span id="toast-message">Th√¥ng b√°o</span>
    </div>

    <!-- Script Injection cho file xu·∫•t -->
    <script>
        const injectionScript = `
        <script>
            function handleCopy(t,b){if(navigator.clipboard){navigator.clipboard.writeText(t).then(()=>eff(b)).catch(()=>fb(t,b))}else fb(t,b)}
            function fb(t,b){var a=document.createElement("textarea");a.value=t;a.style.position="fixed";a.style.left="0";a.style.opacity="0";document.body.appendChild(a);a.focus();a.select();try{if(document.execCommand('copy'))eff(b);else alert('L·ªói copy')}catch(e){}document.body.removeChild(a)}
            function eff(b){var o=b.innerHTML;b.innerHTML='‚úÖ';b.style.color='#16a34a';setTimeout(()=>{b.innerHTML=o;b.style.color=''},2000)}
            window.callCopy=function(b){var p=b.parentElement.querySelector('pre');if(p)handleCopy(p.innerText,b)};
            document.addEventListener('DOMContentLoaded',()=>{const b=document.getElementById('back-to-top');if(b)window.onscroll=()=>{b.style.display=(document.body.scrollTop>300||document.documentElement.scrollTop>300)?'flex':'none'}});
        <\/script>`;
    </script>

    <script>
        const STORAGE_KEY = 'md_editor_v7_full_store';
        const defaultText = `# H∆∞·ªõng D·∫´n & M·∫´u Markdown To√†n Di·ªán

Ch√†o m·ª´ng! ƒê√¢y l√† file m·∫´u d√πng ƒë·ªÉ ki·ªÉm tra kh·∫£ nƒÉng hi·ªÉn th·ªã c·ªßa tr√¨nh so·∫°n th·∫£o.
D∆∞·ªõi ƒë√¢y l√† m·ª•c l·ª•c (B·∫°n c√≥ th·ªÉ click ƒë·ªÉ nh·∫£y ƒë·∫øn t·ª´ng ph·∫ßn nh·ªù t√≠nh nƒÉng t·ª± t·∫°o ID):

**M·ª•c L·ª•c:**
1. [ƒê·ªãnh d·∫°ng vƒÉn b·∫£n](#1-dinh-dang-van-ban)
2. [Danh s√°ch (Lists)](#2-danh-sach-lists)
3. [Li√™n k·∫øt & H√¨nh ·∫£nh](#3-lien-ket-hinh-anh)
4. [M√£ ngu·ªìn (Code Blocks)](#4-ma-nguon-code-blocks)
5. [B·∫£ng bi·ªÉu (Tables)](#5-bang-bieu-tables)
6. [Tr√≠ch d·∫´n (Blockquotes)](#6-trich-dan-blockquotes)
7. [C√°c th√†nh ph·∫ßn kh√°c](#7-cac-thanh-phan-khac)

---

## 1. ƒê·ªãnh d·∫°ng vƒÉn b·∫£n

B·∫°n c√≥ th·ªÉ ƒë·ªãnh d·∫°ng vƒÉn b·∫£n theo nhi·ªÅu ki·ªÉu kh√°c nhau:

- **In ƒë·∫≠m (Bold)**: D√πng hai d·∫•u sao \`**text**\` ho·∫∑c g·∫°ch d∆∞·ªõi \`__text__\`.
- *In nghi√™ng (Italic)*: D√πng m·ªôt d·∫•u sao \`*text*\` ho·∫∑c g·∫°ch d∆∞·ªõi \`_text_\`.
- ***V·ª´a ƒë·∫≠m v·ª´a nghi√™ng***: D√πng ba d·∫•u sao \`***text***\`.
- ~~G·∫°ch ngang (Strikethrough)~~: D√πng hai d·∫•u ng√£ \`~~text~~\`.
- \`Code trong d√≤ng\`: D√πng d·∫•u huy·ªÅn (backtick) \` \`text\` \`.

---

## 2. Danh s√°ch (Lists)

### Danh s√°ch kh√¥ng th·ª© t·ª±
- Ph·∫ßn t·ª≠ 1
- Ph·∫ßn t·ª≠ 2
  - Ph·∫ßn t·ª≠ con 2.1
  - Ph·∫ßn t·ª≠ con 2.2
    - Ph·∫ßn t·ª≠ ch√°u 2.2.1

### Danh s√°ch c√≥ th·ª© t·ª±
1. B∆∞·ªõc th·ª© nh·∫•t
2. B∆∞·ªõc th·ª© hai
3. B∆∞·ªõc th·ª© ba

### Danh s√°ch c√¥ng vi·ªác (Task Lists)
- [x] ƒê√£ ho√†n th√†nh c√¥ng vi·ªác A
- [ ] ƒêang l√†m c√¥ng vi·ªác B
- [ ] Ch∆∞a b·∫Øt ƒë·∫ßu c√¥ng vi·ªác C

---

## 3. Li√™n k·∫øt & H√¨nh ·∫£nh

### Li√™n k·∫øt (Links)
- [Truy c·∫≠p Google](https://www.google.com)
- [Link c√≥ title (r√™ chu·ªôt v√†o ƒë·ªÉ xem)](https://www.google.com "Trang ch·ªß Google")
- ƒê·ªãa ch·ªâ email: <admin@example.com>

### H√¨nh ·∫£nh (Images)
C√∫ ph√°p: \`![VƒÉn b·∫£n thay th·∫ø](ƒë∆∞·ªùng-d·∫´n-·∫£nh)\`

**·∫¢nh t·ª´ Internet:**
![Logo Google](https://www.google.com/images/branding/googlelogo/2x/googlelogo_color_92x30dp.png)

**·∫¢nh t·ª´ m√°y t√≠nh (Local):**
*(L∆∞u √Ω: V·ªõi tr√¨nh so·∫°n th·∫£o n√†y, h√£y ƒë·∫∑t ·∫£nh c√πng th∆∞ m·ª•c ho·∫∑c d√πng n√∫t "N·∫°p ·∫£nh" ƒë·ªÉ xem)*
![·∫¢nh m·∫´u local](demo.png)

---

## 4. M√£ ngu·ªìn (Code Blocks)

ƒê√¢y l√† t√≠nh nƒÉng quan tr·ªçng ƒë·ªÉ ki·ªÉm tra **n√∫t Copy**.

**JavaScript:**
\`\`\`javascript
// H√†m t√≠nh t·ªïng
function sum(a, b) {
    console.log("ƒêang t√≠nh to√°n...");
    return a + b;
}

const result = sum(10, 20);
alert(\`K·∫øt qu·∫£ l√†: \${result}\`);
\`\`\`

**Python:**
\`\`\`python
def hello_world():
    print("Xin ch√†o, ƒë√¢y l√† Python!")

if __name__ == "__main__":
    hello_world()
\`\`\`

**HTML/XML:**
\`\`\`html
<!DOCTYPE html>
<html>
<head>
    <title>Test Code</title>
</head>
<body>
    <h1>Hello World</h1>
</body>
</html>
\`\`\`

**JSON:**
\`\`\`json
{
  "name": "Markdown Editor",
  "version": "4.0",
  "features": ["HTML Export", "PDF Export"]
}
\`\`\`

---

## 5. B·∫£ng bi·ªÉu (Tables)

S·ª≠ d·ª•ng d·∫•u hai ch·∫•m \`:\` ƒë·ªÉ cƒÉn l·ªÅ.

| T√≠nh nƒÉng | Tr·∫°ng th√°i (CƒÉn gi·ªØa) | Ghi ch√∫ (CƒÉn ph·∫£i) |
| :--- | :---: | ---: |
| So·∫°n th·∫£o | ‚úÖ Ho√†n t·∫•t | Real-time |
| Xu·∫•t PDF | ‚úÖ Ho√†n t·∫•t | Kh·ªï A4 |
| Xu·∫•t HTML | ‚úÖ Ho√†n t·∫•t | K√®m CSS |
| Dark Mode | ‚ùå Ch∆∞a c√≥ | S·∫Øp ra m·∫Øt |

---

## 6. Tr√≠ch d·∫´n (Blockquotes)

> ƒê√¢y l√† m·ªôt ƒëo·∫°n tr√≠ch d·∫´n ƒë∆°n gi·∫£n.
> Markdown r·∫•t tuy·ªát v·ªùi.

Tr√≠ch d·∫´n l·ªìng nhau:
> C·∫•p 1
>> C·∫•p 2
>>> C·∫•p 3: "Ki·∫øn th·ª©c l√† s·ª©c m·∫°nh."

---

## 7. C√°c th√†nh ph·∫ßn kh√°c

### ƒê∆∞·ªùng k·∫ª ngang (Horizontal Rule)
D√πng ƒë·ªÉ ng·∫Øt trang ho·∫∑c chia ƒëo·∫°n:

---

### HTML thu·∫ßn (Raw HTML)
B·∫°n c√≥ th·ªÉ vi·∫øt HTML tr·ª±c ti·∫øp n·∫øu c·∫ßn:

<div style="padding: 10px; background-color: #f0fdf4; border: 1px solid #22c55e; border-radius: 5px; color: #15803d;">
    <strong>Th√¥ng b√°o:</strong> ƒê√¢y l√† m·ªôt th·∫ª div ƒë∆∞·ª£c vi·∫øt b·∫±ng HTML thu·∫ßn b√™n trong Markdown!
</div>

<br>

### K√Ω t·ª± ƒë·∫∑c bi·ªát
N·∫øu mu·ªën vi·∫øt d·∫•u sao m√† kh√¥ng b·ªã in ƒë·∫≠m, h√£y d√πng d·∫•u g·∫°ch ch√©o ng∆∞·ª£c:
\\*D√≤ng n√†y kh√¥ng b·ªã in nghi√™ng\\*

---
*K·∫øt th√∫c t√†i li·ªáu m·∫´u.*
`;

        const editor = document.getElementById('editor');
        const previewContainer = document.querySelector('#preview .markdown-body');
        const embeddedImages = new Map();
        
        // --- Helpers ---
        function showToast(msg) {
            const t = document.getElementById('toast');
            document.getElementById('toast-message').innerText = msg;
            t.classList.remove('translate-y-32');
            setTimeout(() => t.classList.add('translate-y-32'), 3000);
        }

        function slugify(text) {
            return text ? text.toString().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/\s+/g, '-').replace(/[^\w\-]+/g, '') : '';
        }

        // --- Extract Title Logic ---
        function getDocumentTitle() {
            const raw = editor.value;
            const match = raw.match(/^#\s+(.+)$/m);
            return match ? match[1].trim() : 'tai-lieu';
        }

        function getSafeFilename(ext) {
            let title = getDocumentTitle();
            // Lo·∫°i b·ªè c√°c k√Ω t·ª± kh√¥ng h·ª£p l·ªá trong t√™n file
            // Gi·ªØ l·∫°i ti·∫øng Vi·ªát v√† kho·∫£ng tr·∫Øng, thay th·∫ø k√Ω t·ª± ƒë·∫∑c bi·ªát b·∫±ng _
            title = title.replace(/[\/\\:*?"<>|]/g, '_');
            return title + ext;
        }

        // --- Config Marked ---
        marked.use({ 
            gfm: true, breaks: true, 
            renderer: { heading(t,l,r) { return `<h${l} id="${slugify(r)}">${t}</h${l}>`; } } 
        });

        // --- Render ---
        function render() {
            const html = DOMPurify.sanitize(marked.parse(editor.value));
            const div = document.createElement('div'); div.innerHTML = html;
            
            // Images
            if (embeddedImages.size > 0) {
                div.querySelectorAll('img').forEach(img => {
                    const src = img.getAttribute('src');
                    if (embeddedImages.has(src)) img.src = embeddedImages.get(src);
                });
            }
            // Copy Btns
            div.querySelectorAll('pre').forEach(pre => {
                const w = document.createElement('div'); w.className = 'code-container';
                pre.parentNode.insertBefore(w, pre); w.appendChild(pre);
                const b = document.createElement('button'); b.className = 'copy-btn'; b.innerHTML = `<span>üìã</span> Copy`;
                b.onclick = () => { if(navigator.clipboard) navigator.clipboard.writeText(pre.innerText).then(()=>{b.innerHTML='‚úÖ';setTimeout(()=>b.innerHTML='<span>üìã</span> Copy',2000)}) };
                w.appendChild(b);
            });
            previewContainer.innerHTML = div.innerHTML;
        }

        // --- Generate HTML String (Core logic d√πng chung) ---
        function getFinalHtml() {
            const raw = document.getElementById('editor').value;
            if(!raw) return null;
            
            const div = document.createElement('div');
            div.innerHTML = DOMPurify.sanitize(marked.parse(raw));

            // Embed Images
            if (embeddedImages.size > 0) {
                div.querySelectorAll('img').forEach(img => {
                    const src = img.getAttribute('src');
                    if (embeddedImages.has(src)) img.src = embeddedImages.get(src);
                });
            }

            // Static Copy Buttons
            div.querySelectorAll('pre').forEach(pre => {
                const w = document.createElement('div'); w.className = 'code-container';
                pre.parentNode.insertBefore(w, pre); w.appendChild(pre);
                const b = document.createElement('button'); b.className = 'copy-btn'; b.innerHTML = `<span>üìã</span> Copy`;
                b.setAttribute('onclick', 'window.callCopy(this)');
                w.appendChild(b);
            });

            const docTitle = getDocumentTitle();
            const styles = document.getElementById('content-styles').innerHTML;
            return `<!DOCTYPE html><html lang="vi"><head><meta charset="UTF-8"><title>${docTitle}</title><style>body{margin:0;padding:40px;background-color:#f3f4f6;position:relative}html{scroll-behavior:smooth}.container{max-width:900px;margin:0 auto;box-shadow:0 4px 6px -1px rgba(0,0,0,0.1);border-radius:8px;overflow:hidden}${styles}</style></head><body><div class="container"><div class="markdown-body">${div.innerHTML}</div></div><button id="back-to-top" onclick="window.scrollTo({top:0,behavior:'smooth'})"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="19" x2="12" y2="5"/><polyline points="5 12 12 5 19 12"/></svg></button>${injectionScript}</body></html>`;
        }

        // --- Actions ---
        function copyMarkdownRaw() {
            const v = editor.value;
            if(navigator.clipboard) navigator.clipboard.writeText(v).then(()=>showToast('ƒê√£ copy Markdown'));
        }

        function copyHtmlToClipboard() {
            const h = getFinalHtml();
            if(h) navigator.clipboard.writeText(h).then(()=>showToast('ƒê√£ copy HTML'));
        }

        function downloadHtmlFile() {
            const h = getFinalHtml();
            if(!h) { showToast('N·ªôi dung tr·ªëng'); return; }
            const blob = new Blob([h], {type: "text/html"});
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = getSafeFilename(".html");
            link.click();
            showToast('ƒêang t·∫£i HTML: ' + link.download);
        }

        function downloadPdfFile() {
            const element = document.querySelector('.markdown-body');
            const filename = getSafeFilename(".pdf");

            const opt = {
                margin:       10, 
                filename:     filename,
                image:        { type: 'jpeg', quality: 0.98 },
                html2canvas:  { scale: 2 },
                jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            const copyBtns = element.querySelectorAll('.copy-btn');
            copyBtns.forEach(b => b.style.display = 'none');

            html2pdf().set(opt).from(element).save().then(() => {
                copyBtns.forEach(b => b.style.display = 'flex');
                showToast('ƒêang t·∫£i PDF: ' + filename);
            });
        }

        function resetStorage() {
            if(confirm("X√≥a n·ªôi dung hi·ªán t·∫°i v√† kh√¥i ph·ª•c M·∫™U ƒê·∫¶Y ƒê·ª¶?")) { 
                localStorage.removeItem(STORAGE_KEY); 
                editor.value = defaultText; 
                render(); 
                showToast("ƒê√£ kh√¥i ph·ª•c m·∫´u!");
            }
        }

        // --- Init & Events ---
        const saved = localStorage.getItem(STORAGE_KEY);
        editor.value = saved || defaultText;
        render();

        editor.addEventListener('input', () => { render(); localStorage.setItem(STORAGE_KEY, editor.value); });
        
        document.getElementById('imageInput').addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            if(!files.length) return;
            let c = 0;
            for(const f of files) {
                const r = new FileReader();
                r.onload = (ev) => { 
                    embeddedImages.set(f.name, ev.target.result); c++;
                    if(c===files.length) { 
                        document.getElementById('img-btn-text').innerText = `${c} ·∫¢nh`; 
                        showToast(`ƒê√£ n·∫°p ${c} ·∫£nh`); 
                        render(); 
                    }
                };
                r.readAsDataURL(f);
            }
        });

        editor.addEventListener('scroll', () => {
            const p = editor.scrollTop / (editor.scrollHeight - editor.clientHeight);
            const ph = previewContainer.parentNode.scrollHeight - previewContainer.parentNode.clientHeight;
            previewContainer.parentNode.scrollTop = p * ph;
        });
    </script>
</body>
</html>

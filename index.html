<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Markdown Editor Pro (V3 - Fix Export)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Marked.js 12.0.2 (Stable) -->
    <script src="https://cdn.jsdelivr.net/npm/marked@12.0.2/marked.min.js"></script>
    <!-- DOMPurify -->
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>

    <style id="content-styles">
        /* --- Styles --- */
        .markdown-body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
            font-size: 16px; line-height: 1.6; word-wrap: break-word; color: #24292f; background-color: #fff; padding: 20px;
        }
        .markdown-body h1, .markdown-body h2, .markdown-body h3 { margin-top: 24px; margin-bottom: 16px; font-weight: 600; line-height: 1.25; scroll-margin-top: 80px; }
        .markdown-body h1 { font-size: 2em; border-bottom: 1px solid #d0d7de; padding-bottom: 0.3em; }
        .markdown-body h2 { font-size: 1.5em; border-bottom: 1px solid #d0d7de; padding-bottom: 0.3em; }
        .markdown-body a { color: #0969da; text-decoration: none; }
        .markdown-body a:hover { text-decoration: underline; }
        .markdown-body ul, .markdown-body ol { padding-left: 2em; margin-bottom: 16px; }
        .markdown-body ul { list-style-type: disc; }
        .markdown-body ol { list-style-type: decimal; }
        .markdown-body blockquote { padding: 0 1em; color: #57606a; border-left: 0.25em solid #d0d7de; margin-bottom: 16px; }
        
        .markdown-body code { padding: 0.2em 0.4em; margin: 0; font-size: 85%; background-color: rgba(175, 184, 193, 0.2); border-radius: 6px; font-family: ui-monospace, SFMono-Regular, SF Mono, Menlo, Consolas, Liberation Mono, monospace; }
        .code-container { position: relative; margin-bottom: 16px; background-color: #f6f8fa; border-radius: 6px; border: 1px solid #d0d7de; }
        .code-container pre { padding: 16px; overflow: auto; margin: 0; border-radius: 6px; padding-top: 40px; }
        .code-container pre code { background-color: transparent; padding: 0; white-space: pre; }

        .copy-btn { position: absolute; top: 5px; right: 5px; padding: 4px 10px; font-size: 12px; color: #24292f; background-color: #f3f4f6; border: 1px solid #d0d7de; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 6px; font-weight: 600; user-select: none; z-index: 10; box-shadow: 0 1px 2px rgba(0,0,0,0.05); line-height: 1; }
        .copy-btn:hover { background-color: #fff; color: #0969da; border-color: #0969da; }
        .copy-btn:active { transform: translateY(1px); }

        .markdown-body img { max-width: 100%; box-sizing: border-box; background-color: #fff; border: 1px solid #d0d7de; border-radius: 6px; }
        .markdown-body table { border-spacing: 0; border-collapse: collapse; margin-bottom: 16px; width: 100%; }
        .markdown-body table th, .markdown-body table td { padding: 6px 13px; border: 1px solid #d0d7de; }
        .markdown-body table tr:nth-child(2n) { background-color: #f6f8fa; }

        #back-to-top { position: fixed; bottom: 30px; right: 30px; background-color: #2563eb; color: white; width: 50px; height: 50px; border-radius: 50%; display: none; justify-content: center; align-items: center; cursor: pointer; border: none; box-shadow: 0 4px 6px rgba(0,0,0,0.2); z-index: 9999; transition: opacity 0.3s, transform 0.2s; }
        #back-to-top:hover { background-color: #1d4ed8; transform: scale(1.1); }
    </style>
</head>
<body class="bg-gray-100 h-screen flex flex-col overflow-hidden">

    <!-- Header -->
    <header class="bg-gray-900 text-white h-16 flex justify-between items-center px-6 shadow-md shrink-0 z-10 gap-4">
        <div class="flex items-center gap-2 min-w-fit">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><line x1="10" y1="9" x2="8" y2="9"/></svg>
            <span class="font-bold text-lg tracking-wide hidden sm:inline">MD Pro V3</span>
        </div>
        
        <div class="flex gap-3 items-center">
            <button onclick="resetStorage()" class="text-xs text-gray-400 hover:text-white underline px-2">Reset</button>
            <input type="file" id="imageInput" multiple accept="image/*" class="hidden">
            <button onclick="document.getElementById('imageInput').click()" class="flex items-center gap-2 bg-gray-700 hover:bg-gray-600 text-gray-200 px-3 py-2 rounded text-sm font-medium transition-colors border border-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
                <span id="img-btn-text">1. N·∫°p ·∫£nh</span>
            </button>
            <button onclick="exportFullHtml()" class="flex items-center gap-2 bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded text-sm font-medium transition-colors shadow-lg shadow-blue-900/50">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                <span>2. Xu·∫•t HTML</span>
            </button>
        </div>
    </header>

    <main class="flex-1 flex flex-row overflow-hidden">
        <div class="w-1/2 flex flex-col border-r border-gray-300 relative group">
            <div class="bg-gray-100 px-4 py-2 text-xs text-gray-500 font-bold uppercase border-b border-gray-300 flex justify-between">
                <span>Markdown Input</span>
                <span id="save-status" class="text-green-600 font-normal hidden">ƒê√£ l∆∞u</span>
            </div>
            <textarea id="editor" class="flex-1 w-full p-6 resize-none outline-none font-mono text-gray-800 text-sm leading-relaxed bg-gray-50 focus:bg-white transition-colors" spellcheck="false"></textarea>
        </div>
        <div class="w-1/2 flex flex-col bg-white">
            <div class="bg-gray-100 px-4 py-2 text-xs text-gray-500 font-bold uppercase border-b border-gray-300 flex justify-between">
                <span>Preview</span>
                <span id="status-text" class="normal-case font-normal text-blue-600"></span>
            </div>
            <div id="preview" class="flex-1 w-full p-0 overflow-y-auto"><div class="markdown-body h-full"></div></div>
        </div>
    </main>

    <div id="toast" class="fixed bottom-5 right-5 bg-gray-800 text-white px-4 py-3 rounded shadow-lg transform translate-y-32 transition-transform duration-300 flex items-center gap-2 z-50">
        <span id="toast-icon">‚úÖ</span>
        <span id="toast-message">Th√¥ng b√°o</span>
    </div>

    <script>
        const STORAGE_KEY = 'md_editor_v3_store'; 
        // ƒê√¢y l√† n·ªôi dung m·∫´u ƒë·∫ßy ƒë·ªß t√≠nh nƒÉng:
        const defaultText = `# H∆∞·ªõng D·∫´n S·ª≠ D·ª•ng ƒê·∫ßy ƒê·ªß

Ch√†o m·ª´ng b·∫°n ƒë·∫øn v·ªõi **Markdown Editor Pro**. D∆∞·ªõi ƒë√¢y l√† demo t·∫•t c·∫£ c√°c t√≠nh nƒÉng.

## M·ª•c L·ª•c (T·ª± ƒë·ªông t·∫°o ID)
B·∫°n c√≥ th·ªÉ click v√†o c√°c link d∆∞·ªõi ƒë√¢y ƒë·ªÉ nh·∫£y ƒë·∫øn t·ª´ng ph·∫ßn (nh·ªù t√≠nh nƒÉng t·ª± ƒë·ªông t·∫°o ID cho th·∫ª Heading):
- [1. ƒê·ªãnh d·∫°ng vƒÉn b·∫£n](#1-dinh-dang-van-ban)
- [2. Ch√®n Code & N√∫t Copy](#2-chen-code-nut-copy)
- [3. B·∫£ng bi·ªÉu (Table)](#3-bang-bieu-table)
- [4. H√¨nh ·∫£nh (Embed Image)](#4-hinh-anh-embed-image)
- [5. C√°c t√≠nh nƒÉng kh√°c](#5-cac-tinh-nang-khac)

---

## 1. ƒê·ªãnh d·∫°ng vƒÉn b·∫£n
Markdown h·ªó tr·ª£ nhi·ªÅu ki·ªÉu ƒë·ªãnh d·∫°ng:
- **In ƒë·∫≠m (Bold)** v√† *In nghi√™ng (Italic)*.
- ~~G·∫°ch ngang (Strikethrough)~~.
- [Link ƒë·∫øn Google](https://google.com).
- Danh s√°ch vi·ªác c·∫ßn l√†m:
  - [x] So·∫°n th·∫£o Markdown.
  - [ ] Xu·∫•t file HTML.

> "ƒê√¢y l√† m·ªôt tr√≠ch d·∫´n (Blockquote). R·∫•t h·ªØu √≠ch ƒë·ªÉ l√†m n·ªïi b·∫≠t th√¥ng tin."

---

## 2. Ch√®n Code & N√∫t Copy
H·ªó tr·ª£ t√¥ m√†u c√∫ ph√°p (Syntax highlighting) v√† **n√∫t Copy** ho·∫°t ƒë·ªông ngay c·∫£ trong file xu·∫•t ra.

**V√≠ d·ª• JavaScript:**
\`\`\`javascript
function sayHello(name) {
    console.log(\`Xin ch√†o \${name}!\`);
    return true;
}
\`\`\`

**V√≠ d·ª• HTML:**
\`\`\`html
<div class="container">
    <p>ƒê√¢y l√† ƒëo·∫°n code m·∫´u.</p>
</div>
\`\`\`

---

## 3. B·∫£ng bi·ªÉu (Table)
T·∫°o b·∫£ng d·ªÖ d√†ng v·ªõi c√∫ ph√°p Markdown:

| T√≠nh nƒÉng | Tr·∫°ng th√°i | Ghi ch√∫ |
| :--- | :---: | :--- |
| **So·∫°n th·∫£o** | ‚úÖ | Real-time preview |
| **N√∫t Copy** | ‚úÖ | Ho·∫°t ƒë·ªông offline |
| **Xu·∫•t HTML** | ‚úÖ | K√®m CSS ƒë·∫πp m·∫Øt |
| **Auto-save** | ‚úÖ | L∆∞u v√†o tr√¨nh duy·ªát |

---

## 4. H√¨nh ·∫£nh (Embed Image)
ƒê·ªÉ ch√®n ·∫£nh t·ª´ m√°y t√≠nh v√† g·ª≠i cho ng∆∞·ªùi kh√°c xem ƒë∆∞·ª£c:
1. ƒê·∫∑t file ·∫£nh c√πng th∆∞ m·ª•c (v√≠ d·ª•: \`demo.png\`).
2. Vi·∫øt markdown: \`![M√¥ t·∫£ ·∫£nh](demo.png)\`.
3. B·∫•m n√∫t **"1. N·∫°p ·∫£nh"** tr√™n thanh c√¥ng c·ª• v√† ch·ªçn file \`demo.png\`.
4. Khi xu·∫•t file HTML, ·∫£nh s·∫Ω ƒë∆∞·ª£c nh√∫ng th·∫≥ng v√†o file (kh√¥ng c·∫ßn g·ª≠i k√®m file ·∫£nh r·ªùi).

---

## 5. C√°c t√≠nh nƒÉng kh√°c
### 5.1. N√∫t "Back to Top"
H√£y th·ª≠ cu·ªôn xu·ªëng cu·ªëi trang n√†y trong ph·∫ßn Preview ho·∫∑c file xu·∫•t ra. B·∫°n s·∫Ω th·∫•y m·ªôt n√∫t m≈©i t√™n m√†u xanh ·ªü g√≥c d∆∞·ªõi b√™n ph·∫£i ƒë·ªÉ quay l·∫°i ƒë·∫ßu trang.

### 5.2. T·ª± ƒë·ªông l∆∞u (Auto-save)
N·ªôi dung b·∫°n g√µ s·∫Ω ƒë∆∞·ª£c l∆∞u v√†o tr√¨nh duy·ªát. Th·ª≠ t·∫Øt tab v√† m·ªü l·∫°i, n·ªôi dung v·∫´n c√≤n ƒë√≥.

### 5.3. Xu·∫•t file HTML tr·ªçn g√≥i
B·∫•m n√∫t **"2. Xu·∫•t HTML"** ƒë·ªÉ copy to√†n b·ªô m√£ ngu·ªìn. File k·∫øt qu·∫£ l√† m·ªôt trang web ƒë·ªôc l·∫≠p, c√≥ th·ªÉ g·ª≠i qua email ho·∫∑c chat m√† kh√¥ng b·ªã l·ªói hi·ªÉn th·ªã.

<br><br><br><br><br><br><br>
*(Kho·∫£ng tr·∫Øng n√†y ƒë·ªÉ demo n√∫t cu·ªôn trang)*
<br><br><br><br><br><br><br>
H·∫øt trang.
`;

        const editorElement = document.getElementById('editor'); // D√πng t√™n bi·∫øn r√µ r√†ng
        const previewContainer = document.querySelector('#preview .markdown-body');
        const toast = document.getElementById('toast');
        const imageInput = document.getElementById('imageInput');
        const saveStatus = document.getElementById('save-status');
        const embeddedImages = new Map();

        // C·∫•u h√¨nh Marked
        function slugify(text) {
            if (!text) return '';
            return text.toString().toLowerCase()
                .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
                .replace(/\s+/g, '-').replace(/[^\w\-]+/g, '')
                .replace(/\-\-+/g, '-').replace(/^-+/, '').replace(/-+$/, '');
        }
        const renderer = {
            heading(text, level, raw) {
                const slug = slugify(raw);
                return `<h${level} id="${slug}">${text}</h${level}>`;
            }
        };
        marked.use({ gfm: true, breaks: true, renderer: renderer });

        // Logic Copy & BackToTop nh√∫ng v√†o file xu·∫•t
        const injectionScript = `
        <script>
            function handleCopy(text, btnElement) {
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(text).then(() => showCopiedEffect(btnElement)).catch(() => fallbackCopy(text, btnElement));
                } else fallbackCopy(text, btnElement);
            }
            function fallbackCopy(text, btnElement) {
                var ta = document.createElement("textarea");
                ta.value = text; ta.style.position="fixed"; ta.style.left="0"; ta.style.top="0"; ta.style.opacity="0";
                document.body.appendChild(ta); ta.focus(); ta.select();
                try { 
                    var s = document.execCommand('copy'); 
                    if(s) showCopiedEffect(btnElement); else alert('Tr√¨nh duy·ªát ch·∫∑n copy.');
                } catch(e){}
                document.body.removeChild(ta);
            }
            function showCopiedEffect(btn) {
                const old = btn.innerHTML; btn.innerHTML = '<span>‚úÖ</span> ƒê√£ ch√©p'; btn.style.color='#16a34a'; btn.style.borderColor='#16a34a';
                setTimeout(() => { btn.innerHTML = old; btn.style.color=''; btn.style.borderColor=''; }, 2000);
            }
            window.callCopy = function(btn) {
                 var pre = btn.parentElement.querySelector('pre');
                 if(pre) handleCopy(pre.innerText, btn);
            };
            document.addEventListener('DOMContentLoaded', () => {
                const b = document.getElementById('back-to-top');
                if(b) window.onscroll = function(){ b.style.display = (document.body.scrollTop>300||document.documentElement.scrollTop>300)?'flex':'none'; };
            });
        <\/script>`;

        function showToast(msg) {
            document.getElementById('toast-message').innerText = msg;
            toast.classList.remove('translate-y-32');
            setTimeout(() => toast.classList.add('translate-y-32'), 3000);
        }

        // Render & Update
        function render() {
            // L·∫•y gi√° tr·ªã tr·ª±c ti·∫øp t·ª´ DOM ƒë·ªÉ ch·∫Øc ch·∫Øn
            const val = document.getElementById('editor').value; 
            const html = DOMPurify.sanitize(marked.parse(val));
            const div = document.createElement('div'); div.innerHTML = html;
            
            // X·ª≠ l√Ω ·∫£nh preview
            if (embeddedImages.size > 0) {
                div.querySelectorAll('img').forEach(img => {
                    const src = img.getAttribute('src');
                    if (embeddedImages.has(src)) img.src = embeddedImages.get(src);
                });
            }
            // Th√™m n√∫t copy preview
            div.querySelectorAll('pre').forEach(pre => {
                const wrap = document.createElement('div'); wrap.className = 'code-container';
                pre.parentNode.insertBefore(wrap, pre); wrap.appendChild(pre);
                const btn = document.createElement('button'); btn.className = 'copy-btn'; btn.innerHTML = `<span>üìã</span> Copy`;
                btn.onclick = function() { 
                     if(navigator.clipboard) navigator.clipboard.writeText(pre.innerText).then(()=>{ btn.innerHTML='‚úÖ'; setTimeout(()=>btn.innerHTML='<span>üìã</span> Copy',2000); });
                };
                wrap.appendChild(btn);
            });
            previewContainer.innerHTML = div.innerHTML;
        }

        // Event Listeners
        function saveData() {
            const currentVal = document.getElementById('editor').value;
            localStorage.setItem(STORAGE_KEY, currentVal);
            saveStatus.classList.remove('hidden');
            setTimeout(() => saveStatus.classList.add('hidden'), 1000);
            render();
        }

        editorElement.addEventListener('input', saveData);
        editorElement.addEventListener('change', saveData); // Th√™m change ƒë·ªÉ ch·∫Øc ch·∫Øn

        function resetStorage() {
            if(confirm("X√≥a v√† v·ªÅ m·∫∑c ƒë·ªãnh?")) {
                localStorage.removeItem(STORAGE_KEY);
                editorElement.value = defaultText;
                render();
            }
        }

        imageInput.addEventListener('change', async (e) => {
            const files = Array.from(e.target.files);
            if (files.length === 0) return;
            let count = 0;
            for (const file of files) {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    embeddedImages.set(file.name, ev.target.result);
                    count++;
                    if (count === files.length) {
                        document.getElementById('img-btn-text').innerText = `ƒê√£ n·∫°p ${embeddedImages.size} ·∫£nh`;
                        showToast(`ƒê√£ n·∫°p ${files.length} ·∫£nh!`);
                        render();
                    }
                };
                reader.readAsDataURL(file);
            }
        });

        // H√ÄM XU·∫§T HTML QUAN TR·ªåNG
        function exportFullHtml() {
            // QUAN TR·ªåNG: L·∫•y d·ªØ li·ªáu t∆∞∆°i nh·∫•t tr·ª±c ti·∫øp t·ª´ √¥ input
            const freshContent = document.getElementById('editor').value;

            if (!freshContent) { showToast('N·ªôi dung tr·ªëng!'); return; }

            const rawHtml = DOMPurify.sanitize(marked.parse(freshContent));
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = rawHtml;

            // X·ª≠ l√Ω ·∫£nh cho file xu·∫•t
            if (embeddedImages.size > 0) {
                tempDiv.querySelectorAll('img').forEach(img => {
                    const src = img.getAttribute('src');
                    if (embeddedImages.has(src)) img.src = embeddedImages.get(src);
                });
            }

            // G·∫Øn n√∫t copy tƒ©nh
            tempDiv.querySelectorAll('pre').forEach(pre => {
                const wrap = document.createElement('div'); wrap.className = 'code-container';
                pre.parentNode.insertBefore(wrap, pre); wrap.appendChild(pre);
                const btn = document.createElement('button'); btn.className = 'copy-btn'; btn.innerHTML = `<span>üìã</span> Copy`;
                btn.setAttribute('onclick', 'window.callCopy(this)');
                wrap.appendChild(btn);
            });

            const content = tempDiv.innerHTML;
            const styles = document.getElementById('content-styles').innerHTML;

            const finalHtml = `<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8"><title>T√†i li·ªáu</title>
<style>
 body{margin:0;padding:40px;background-color:#f3f4f6;position:relative} html{scroll-behavior:smooth}
 .container{max-width:900px;margin:0 auto;box-shadow:0 4px 6px -1px rgba(0,0,0,0.1);border-radius:8px;overflow:hidden}
 ${styles}
</style>
</head>
<body>
 <div class="container"><div class="markdown-body">${content}</div></div>
 <button id="back-to-top" onclick="window.scrollTo({top:0,behavior:'smooth'})">
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="19" x2="12" y2="5"/><polyline points="5 12 12 5 19 12"/></svg>
 </button>
 ${injectionScript}
</body>
</html>`;

            navigator.clipboard.writeText(finalHtml).then(() => showToast('ƒê√£ copy HTML!'))
            .catch(() => {
                const ta = document.createElement("textarea"); ta.value = finalHtml; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
                showToast('ƒê√£ copy HTML (Fallback)!');
            });
        }

        // Init
        const saved = localStorage.getItem(STORAGE_KEY);
        editorElement.value = saved ? saved : defaultText;
        render();

        editorElement.addEventListener('scroll', () => {
            const p = editorElement.scrollTop / (editorElement.scrollHeight - editorElement.clientHeight);
            const ph = previewContainer.parentNode.scrollHeight - previewContainer.parentNode.clientHeight;
            previewContainer.parentNode.scrollTop = p * ph;
        });
    </script>
</body>
</html>
